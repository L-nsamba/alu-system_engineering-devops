#!/usr/bin/env bash
# Install and configure HAProxy load balancer

set -e

# === Variables ===
STUDENT_ID=6871
WEB01="${STUDENT_ID}-web-01"
WEB02="${STUDENT_ID}-web-02"

WEB01_IP="52.87.192.192"
WEB02_IP="52.91.235.48"

# === Install HAProxy ===
apt-get update -y
apt-get install -y haproxy

# === Enable HAProxy via init script ===
sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/haproxy

# === Configure HAProxy ===
cat > /etc/haproxy/haproxy.cfg << EOF
global
    daemon
    maxconn 256

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server ${WEB01} ${WEB01_IP}:80
    server ${WEB02} ${WEB02_IP}:80
EOF

# === Start HAProxy ===
service haproxy restart

# === Display configuration info ===
echo "HAProxy load balancer installed and configured successfully!"
echo "Load balancer is distributing traffic using roundrobin algorithm between:"
echo "- web-01 (${WEB01_IP})"
echo "- web-02 (${WEB02_IP})"
