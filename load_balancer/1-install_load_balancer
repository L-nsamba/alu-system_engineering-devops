#!/usr/bin/env bash
# Install and configure HAProxy load balancer

set -e

# === Variables ===
WEB01_IP="52.87.192.192"
WEB02_IP="52.91.235.48"

# === Install HAProxy ===
apt-get update -y
apt-get install -y haproxy

# === Stop any existing HAProxy ===
service haproxy stop 2>/dev/null || true
pkill haproxy 2>/dev/null || true

# === Enable HAProxy via init script ===
sed -i 's/ENABLED=0/ENABLED=1/' /etc/default/haproxy

# === Configure HAProxy ===
sudo tee /etc/haproxy/haproxy.cfg > /dev/null << EOF
global
    daemon
    maxconn 256

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server web-01 ${WEB01_IP}:80
    server web-02 ${WEB02_IP}:80
EOF

# === Test configuration ===
haproxy -c -f /etc/haproxy/haproxy.cfg

# === Start HAProxy ===
service haproxy start

# === Wait for HAProxy to start ===
sleep 3

# === Display configuration info ===
echo "HAProxy load balancer installed and configured successfully!"
echo "Load balancer is distributing traffic using roundrobin algorithm between:"
echo "web-01"
echo "web-02"
